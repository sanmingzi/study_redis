# redis 过期策略

## 定时扫描策略

1. redis 将所有设置了过期时间的 key 放入一个独立的字典中
2. redis 会定时扫描该字典，默认是 10次 / s
3. 每次扫描从字典中取出 20 个 keys
4. 删除这 20 个 keys 中已经过期的 keys
5. 如果过期的 key 的比例超过了 1/4，重复步骤 3，为了保证每次扫描不循环过度导致线程卡死，每次扫描默认的时间上限为 25 ms

如果有大批量 keys 同时过期，一定要设置一个随机范围，不能全部同时过期，这会导致 redis 服务卡住。

## 从节点的过期策略

从节点不进行定时扫描。主节点在 key 到期时，会在 AOF 文件中增加 del 命令，从节点同步并执行这个命令来删除该 key。由于主从同步是异步的，所以会出现主从数据不一致的情况。集群环境下分布式锁的 bug 就是因为这个产生的。
